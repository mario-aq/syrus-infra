"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.SqsFifoWithDlq = void 0;
const constructs_1 = require("constructs");
const sqs = require("aws-cdk-lib/aws-sqs");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const aws_cdk_lib_2 = require("aws-cdk-lib");
/**
 * Creates a FIFO SQS queue with a FIFO dead letter queue
 */
class SqsFifoWithDlq extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const visibilityTimeout = props.visibilityTimeout || aws_cdk_lib_1.Duration.seconds(60);
        const retentionPeriod = props.retentionPeriod || aws_cdk_lib_1.Duration.days(4);
        const maxReceiveCount = props.maxReceiveCount || 5;
        // Create the dead letter queue first
        const dlqName = `syrus-${props.queueName}-dlq-${props.stage}.fifo`;
        this.dlq = new sqs.Queue(this, 'DLQ', {
            queueName: dlqName,
            fifo: true,
            contentBasedDeduplication: false,
            encryption: sqs.QueueEncryption.SQS_MANAGED,
            retentionPeriod: retentionPeriod,
        });
        // Create the main FIFO queue
        const queueName = `syrus-${props.queueName}-${props.stage}.fifo`;
        this.queue = new sqs.Queue(this, 'Queue', {
            queueName: queueName,
            fifo: true,
            contentBasedDeduplication: false,
            encryption: sqs.QueueEncryption.SQS_MANAGED,
            visibilityTimeout: visibilityTimeout,
            retentionPeriod: retentionPeriod,
            deadLetterQueue: {
                queue: this.dlq,
                maxReceiveCount: maxReceiveCount,
            },
        });
        // Add tags
        aws_cdk_lib_2.Tags.of(this.queue).add('App', 'Syrus');
        aws_cdk_lib_2.Tags.of(this.queue).add('Service', 'WhatsAppBot');
        aws_cdk_lib_2.Tags.of(this.queue).add('Stage', props.stage);
        aws_cdk_lib_2.Tags.of(this.dlq).add('App', 'Syrus');
        aws_cdk_lib_2.Tags.of(this.dlq).add('Service', 'WhatsAppBot');
        aws_cdk_lib_2.Tags.of(this.dlq).add('Stage', props.stage);
    }
}
exports.SqsFifoWithDlq = SqsFifoWithDlq;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3FzLWZpZm8td2l0aC1kbHEuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzcXMtZmlmby13aXRoLWRscS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwyQ0FBdUM7QUFDdkMsMkNBQTJDO0FBQzNDLDZDQUFrRDtBQUNsRCw2Q0FBbUM7QUFzQm5DOztHQUVHO0FBQ0gsTUFBYSxjQUFlLFNBQVEsc0JBQVM7SUFJM0MsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUEwQjtRQUNsRSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLE1BQU0saUJBQWlCLEdBQUcsS0FBSyxDQUFDLGlCQUFpQixJQUFJLHNCQUFRLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzFFLE1BQU0sZUFBZSxHQUFHLEtBQUssQ0FBQyxlQUFlLElBQUksc0JBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbEUsTUFBTSxlQUFlLEdBQUcsS0FBSyxDQUFDLGVBQWUsSUFBSSxDQUFDLENBQUM7UUFFbkQscUNBQXFDO1FBQ3JDLE1BQU0sT0FBTyxHQUFHLFNBQVMsS0FBSyxDQUFDLFNBQVMsUUFBUSxLQUFLLENBQUMsS0FBSyxPQUFPLENBQUM7UUFDbkUsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRTtZQUNwQyxTQUFTLEVBQUUsT0FBTztZQUNsQixJQUFJLEVBQUUsSUFBSTtZQUNWLHlCQUF5QixFQUFFLEtBQUs7WUFDaEMsVUFBVSxFQUFFLEdBQUcsQ0FBQyxlQUFlLENBQUMsV0FBVztZQUMzQyxlQUFlLEVBQUUsZUFBZTtTQUNqQyxDQUFDLENBQUM7UUFFSCw2QkFBNkI7UUFDN0IsTUFBTSxTQUFTLEdBQUcsU0FBUyxLQUFLLENBQUMsU0FBUyxJQUFJLEtBQUssQ0FBQyxLQUFLLE9BQU8sQ0FBQztRQUNqRSxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsT0FBTyxFQUFFO1lBQ3hDLFNBQVMsRUFBRSxTQUFTO1lBQ3BCLElBQUksRUFBRSxJQUFJO1lBQ1YseUJBQXlCLEVBQUUsS0FBSztZQUNoQyxVQUFVLEVBQUUsR0FBRyxDQUFDLGVBQWUsQ0FBQyxXQUFXO1lBQzNDLGlCQUFpQixFQUFFLGlCQUFpQjtZQUNwQyxlQUFlLEVBQUUsZUFBZTtZQUNoQyxlQUFlLEVBQUU7Z0JBQ2YsS0FBSyxFQUFFLElBQUksQ0FBQyxHQUFHO2dCQUNmLGVBQWUsRUFBRSxlQUFlO2FBQ2pDO1NBQ0YsQ0FBQyxDQUFDO1FBRUgsV0FBVztRQUNYLGtCQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ3hDLGtCQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLGFBQWEsQ0FBQyxDQUFDO1FBQ2xELGtCQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUU5QyxrQkFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxPQUFPLENBQUMsQ0FBQztRQUN0QyxrQkFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxhQUFhLENBQUMsQ0FBQztRQUNoRCxrQkFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDOUMsQ0FBQztDQUNGO0FBN0NELHdDQTZDQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0ICogYXMgc3FzIGZyb20gJ2F3cy1jZGstbGliL2F3cy1zcXMnO1xuaW1wb3J0IHsgRHVyYXRpb24sIENmbk91dHB1dCB9IGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCB7IFRhZ3MgfSBmcm9tICdhd3MtY2RrLWxpYic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgU3FzRmlmb1dpdGhEbHFQcm9wcyB7XG4gIC8qKiBRdWV1ZSBuYW1lIHdpdGhvdXQgLmZpZm8gc3VmZml4IChlLmcuLCAnaW5mZXJlbmNlJyBiZWNvbWVzICdzeXJ1cy1pbmZlcmVuY2Ute3N0YWdlfS5maWZvJykgKi9cbiAgcXVldWVOYW1lOiBzdHJpbmc7XG4gIC8qKiBEZXBsb3ltZW50IHN0YWdlIChkZXYvcHJvZCkgKi9cbiAgc3RhZ2U6IHN0cmluZztcbiAgLyoqIFZpc2liaWxpdHkgdGltZW91dCBmb3IgbWVzc2FnZXMgKGRlZmF1bHQ6IDYwIHNlY29uZHMpICovXG4gIHZpc2liaWxpdHlUaW1lb3V0PzogRHVyYXRpb247XG4gIC8qKiBNZXNzYWdlIHJldGVudGlvbiBwZXJpb2QgKGRlZmF1bHQ6IDQgZGF5cykgKi9cbiAgcmV0ZW50aW9uUGVyaW9kPzogRHVyYXRpb247XG4gIC8qKiBNYXhpbXVtIHJlY2VpdmUgY291bnQgYmVmb3JlIG1vdmluZyB0byBETFEgKGRlZmF1bHQ6IDUpICovXG4gIG1heFJlY2VpdmVDb3VudD86IG51bWJlcjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBTcXNGaWZvV2l0aERscVJlc3VsdCB7XG4gIC8qKiBUaGUgbWFpbiBGSUZPIHF1ZXVlICovXG4gIHF1ZXVlOiBzcXMuUXVldWU7XG4gIC8qKiBUaGUgZGVhZCBsZXR0ZXIgcXVldWUgKi9cbiAgZGxxOiBzcXMuUXVldWU7XG59XG5cbi8qKlxuICogQ3JlYXRlcyBhIEZJRk8gU1FTIHF1ZXVlIHdpdGggYSBGSUZPIGRlYWQgbGV0dGVyIHF1ZXVlXG4gKi9cbmV4cG9ydCBjbGFzcyBTcXNGaWZvV2l0aERscSBleHRlbmRzIENvbnN0cnVjdCB7XG4gIHB1YmxpYyByZWFkb25seSBxdWV1ZTogc3FzLlF1ZXVlO1xuICBwdWJsaWMgcmVhZG9ubHkgZGxxOiBzcXMuUXVldWU7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IFNxc0ZpZm9XaXRoRGxxUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgY29uc3QgdmlzaWJpbGl0eVRpbWVvdXQgPSBwcm9wcy52aXNpYmlsaXR5VGltZW91dCB8fCBEdXJhdGlvbi5zZWNvbmRzKDYwKTtcbiAgICBjb25zdCByZXRlbnRpb25QZXJpb2QgPSBwcm9wcy5yZXRlbnRpb25QZXJpb2QgfHwgRHVyYXRpb24uZGF5cyg0KTtcbiAgICBjb25zdCBtYXhSZWNlaXZlQ291bnQgPSBwcm9wcy5tYXhSZWNlaXZlQ291bnQgfHwgNTtcblxuICAgIC8vIENyZWF0ZSB0aGUgZGVhZCBsZXR0ZXIgcXVldWUgZmlyc3RcbiAgICBjb25zdCBkbHFOYW1lID0gYHN5cnVzLSR7cHJvcHMucXVldWVOYW1lfS1kbHEtJHtwcm9wcy5zdGFnZX0uZmlmb2A7XG4gICAgdGhpcy5kbHEgPSBuZXcgc3FzLlF1ZXVlKHRoaXMsICdETFEnLCB7XG4gICAgICBxdWV1ZU5hbWU6IGRscU5hbWUsXG4gICAgICBmaWZvOiB0cnVlLFxuICAgICAgY29udGVudEJhc2VkRGVkdXBsaWNhdGlvbjogZmFsc2UsXG4gICAgICBlbmNyeXB0aW9uOiBzcXMuUXVldWVFbmNyeXB0aW9uLlNRU19NQU5BR0VELFxuICAgICAgcmV0ZW50aW9uUGVyaW9kOiByZXRlbnRpb25QZXJpb2QsXG4gICAgfSk7XG5cbiAgICAvLyBDcmVhdGUgdGhlIG1haW4gRklGTyBxdWV1ZVxuICAgIGNvbnN0IHF1ZXVlTmFtZSA9IGBzeXJ1cy0ke3Byb3BzLnF1ZXVlTmFtZX0tJHtwcm9wcy5zdGFnZX0uZmlmb2A7XG4gICAgdGhpcy5xdWV1ZSA9IG5ldyBzcXMuUXVldWUodGhpcywgJ1F1ZXVlJywge1xuICAgICAgcXVldWVOYW1lOiBxdWV1ZU5hbWUsXG4gICAgICBmaWZvOiB0cnVlLFxuICAgICAgY29udGVudEJhc2VkRGVkdXBsaWNhdGlvbjogZmFsc2UsXG4gICAgICBlbmNyeXB0aW9uOiBzcXMuUXVldWVFbmNyeXB0aW9uLlNRU19NQU5BR0VELFxuICAgICAgdmlzaWJpbGl0eVRpbWVvdXQ6IHZpc2liaWxpdHlUaW1lb3V0LFxuICAgICAgcmV0ZW50aW9uUGVyaW9kOiByZXRlbnRpb25QZXJpb2QsXG4gICAgICBkZWFkTGV0dGVyUXVldWU6IHtcbiAgICAgICAgcXVldWU6IHRoaXMuZGxxLFxuICAgICAgICBtYXhSZWNlaXZlQ291bnQ6IG1heFJlY2VpdmVDb3VudCxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICAvLyBBZGQgdGFnc1xuICAgIFRhZ3Mub2YodGhpcy5xdWV1ZSkuYWRkKCdBcHAnLCAnU3lydXMnKTtcbiAgICBUYWdzLm9mKHRoaXMucXVldWUpLmFkZCgnU2VydmljZScsICdXaGF0c0FwcEJvdCcpO1xuICAgIFRhZ3Mub2YodGhpcy5xdWV1ZSkuYWRkKCdTdGFnZScsIHByb3BzLnN0YWdlKTtcblxuICAgIFRhZ3Mub2YodGhpcy5kbHEpLmFkZCgnQXBwJywgJ1N5cnVzJyk7XG4gICAgVGFncy5vZih0aGlzLmRscSkuYWRkKCdTZXJ2aWNlJywgJ1doYXRzQXBwQm90Jyk7XG4gICAgVGFncy5vZih0aGlzLmRscSkuYWRkKCdTdGFnZScsIHByb3BzLnN0YWdlKTtcbiAgfVxufVxuIl19